{% extends 'base.html' %}
{% load static %}

{% block title %}{{ target_user.first_name|default:target_user.username }} ê°•ì‚¬ ëŒ€ì‹œë³´ë“œ{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'teacherpage/css/dashboard.css' %}">
<style>
    /* âœ… feature: ì¹´ë“œ í´ë¦­ íš¨ê³¼ ë° ì•Œë¦¼ ì (dot) ìŠ¤íƒ€ì¼ ê²°í•© */
    .course-card {
        cursor: pointer;
        transition: all 0.25s ease;
    }
    .course-card:hover {
        border-color: #00c471;
        transform: translateY(-4px);
        box-shadow: 0 12px 20px rgba(0, 196, 113, 0.08);
    }
    .msg-indicator {
        position: relative;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 6px 10px;
        border: 1px solid var(--border);
        background: var(--soft-bg);
        border-radius: 8px;
        font-size: 16px;
    }
    .msg-indicator.muted { opacity: 0.4; }
    .msg-indicator .dot {
        position: absolute;
        top: -2px; right: -2px;
        width: 10px; height: 10px;
        border-radius: 50%;
        background: #ff4d4f;
        border: 2px solid var(--card);
    }
</style>
{% endblock %}

{% block content %}
<div class="profile-container surface">

    <div class="profile-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <div class="profile-info-group" style="display: flex; gap: 20px; align-items: center;">
            <img class="profile-avatar"
                 src="{% if target_user.profile_image %}{{ target_user.profile_image.url }}{% else %}{% static 'images/default_thumbnail.png' %}{% endif %}"
                 alt="í”„ë¡œí•„"
                 style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border);">
            <div>
                <h2 class="profile-name" style="margin: 0; font-size: 26px; font-weight: 800;">{{ target_user.first_name|default:target_user.username }}</h2>
                <p class="profile-username subtext" style="margin-top: 4px;">@{{ target_user.username }} Â· ê°•ì‚¬</p>
            </div>
        </div>

        <div class="header-actions">
            <a class="btn-outline" href="{% url 'course:course_create' %}">ê°•ì˜ ë“±ë¡</a>
        </div>
    </div>

    <div class="stat-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 35px;">
        <a href="{% url 'course:my_courses' %}" class="stat-box-link" style="text-decoration: none; color: inherit;">
            <div class="stat-box surface no-shadow" style="padding: 20px; border: 1px solid var(--border); border-radius: 12px;">
                <span class="stat-label" style="font-size: 13px; color: var(--muted); display: block; margin-bottom: 5px;">ğŸ“š ë‚´ ê°•ì˜</span>
                <p class="stat-value" style="font-size: 18px; font-weight: 700; margin: 0;">{{ total_courses|default:"0" }}ê°œ</p>
            </div>
        </a>
        <a href="{% url 'teacherpage:students_all' %}" class="stat-box-link" style="text-decoration: none; color: inherit;">
            <div class="stat-box surface no-shadow" style="padding: 20px; border: 1px solid var(--border); border-radius: 12px;">
                <span class="stat-label" style="font-size: 13px; color: var(--muted); display: block; margin-bottom: 5px;">ğŸ‘¥ ì „ì²´ ìˆ˜ê°•ìƒ(ì¤‘ë³µ ì œì™¸)</span>
                <p class="stat-value" style="font-size: 18px; font-weight: 700; margin: 0;">{{ total_students|default:"0" }}ëª…</p>
            </div>
        </a>
    </div>

    <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--border); padding-bottom: 10px; margin-bottom: 15px;">
        <span class="section-title" style="font-size: 18px; font-weight: 700;">ê°•ì‚¬ ì†Œê°œ</span>
        {% if request.user == target_user %}
            <button class="edit-trigger btn-ghost" id="bioEditBtn" onclick="showEditForm()" style="padding: 6px 12px; font-size: 13px; border-radius: 8px;">ìˆ˜ì •í•˜ê¸°</button>
        {% endif %}
    </div>

    <div class="bio-box surface no-shadow" style="padding: 25px; border-radius: 12px; border: 1px solid var(--border); min-height: 120px;">
        <div id="bio-display">
            {% if target_user.bio %}
                <div class="bio-text" style="white-space: pre-wrap; line-height: 1.6;">{{ target_user.bio }}</div>
            {% else %}
                <p class="bio-empty muted" style="text-align:center;">ê°•ì‚¬ ì†Œê°œê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤. ìˆ˜ê°•ìƒì—ê²Œ ì†Œê°œë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”!</p>
            {% endif %}
        </div>

        {% if request.user == target_user %}
        <form method="POST" action="{% url 'teacherpage:dashboard' %}" id="bio-form" style="display:none;">
            {% csrf_token %}
            <textarea name="bio" id="bio-input" class="bio-textarea" rows="5" style="width: 100%; border: 1px solid #00c471; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: var(--soft-bg); color: var(--text);">{{ target_user.bio }}</textarea>
            
            <div id="btn-group" class="btn-group" style="display: flex; justify-content: flex-end; gap: 8px;">
                <button type="button" class="btn-gray" onclick="hideEditForm()" style="background: #adb5bd; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-weight: bold; cursor: pointer;">ì·¨ì†Œ</button>
                <button type="submit" class="btn-save" style="background: #00c471; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-weight: bold; cursor: pointer;">ì €ì¥í•˜ê¸°</button>
            </div>
        </form>
        {% endif %}
    </div>

    <div class="section-header section-gap" style="margin-top: 40px; border-bottom: 2px solid var(--border); padding-bottom: 10px; margin-bottom: 15px;">
        <span class="section-title" style="font-size: 18px; font-weight: 700;">ê°•ì˜ ê´€ë¦¬</span>
    </div>

    <div class="course-list" style="display: flex; flex-direction: column; gap: 15px;">
        {% for course in my_courses %}
            <div class="course-card surface" data-href="{% url 'course:course_detail' course.id %}" style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-radius: 16px; border: 1px solid var(--border);">
                
                <div class="course-left" style="display: flex; gap: 15px; align-items: center;">
                    {% if course.thumbnail %}
                        <img class="thumb" src="{{ course.thumbnail.url }}" alt="ì¸ë„¤ì¼" style="width: 110px; height: 68px; border-radius: 8px; object-fit: cover;">
                    {% else %}
                        <img class="thumb" src="{% static 'images/default_thumbnail.png' %}" alt="ê¸°ë³¸ ì¸ë„¤ì¼" style="width: 110px; height: 68px; border-radius: 8px; object-fit: cover;">
                    {% endif %}

                    <div class="course-meta">
                        <p class="course-title" style="font-weight: bold; font-size: 16px; margin: 0 0 8px 0;">{{ course.title }}</p>
                        <div class="course-sub" style="display: flex; gap: 8px; font-size: 12px; color: var(--muted); flex-wrap: wrap;">
                            <span class="pill" style="background: var(--soft-bg); padding: 4px 10px; border-radius: 999px;">ê°€ê²©: {{ course.price }}</span>
                            <span class="pill" style="background: var(--soft-bg); padding: 4px 10px; border-radius: 999px;">ìˆ˜ê°•ìƒ: {{ course.student_count|default:"0" }}ëª…</span>
                            {% if course.video %}
                                <span class="pill" style="background: var(--soft-bg); padding: 4px 10px; border-radius: 999px;">ì˜ìƒ: ë“±ë¡ë¨</span>
                            {% endif %}
                            <span class="pill" style="background: var(--soft-bg); padding: 4px 10px; border-radius: 999px;">ë“±ë¡ì¼: {{ course.created_at|date:"Y-m-d" }}</span>
                        </div>
                    </div>
                </div>

                <div class="course-actions" style="display: flex; gap: 8px; align-items: center;">
                    {% if course.unread_chat_count|default:0 > 0 %}
                        <span class="msg-indicator" title="ìƒˆ ë©”ì‹œì§€ ìˆìŒ">ğŸ’¬<span class="dot"></span></span>
                    {% else %}
                        <span class="msg-indicator muted" title="ìƒˆ ë©”ì‹œì§€ ì—†ìŒ">ğŸ’¬</span>
                    {% endif %}

                    <a class="btn-sm" href="{% url 'teacherpage:course_students' course.id %}" data-stop="1" style="padding: 8px 12px; border: 1px solid #00c471; color: #00c471; border-radius: 8px; text-decoration: none; font-weight: bold;">ìˆ˜ê°•ìƒ</a>
                    <a class="btn-sm" href="{% url 'course:course_update' course.id %}" data-stop="1" style="padding: 8px 12px; border: 1px solid #00c471; color: #00c471; border-radius: 8px; text-decoration: none; font-weight: bold;">ìˆ˜ì •</a>
                    <a class="btn-danger-sm" href="{% url 'teacherpage:course_delete' course.id %}" data-stop="1" style="padding: 8px 12px; background: #ffe3e3; color: #fa5252; border-radius: 8px; text-decoration: none; font-weight: bold;">ì‚­ì œ</a>
                </div>

            </div>
        {% empty %}
            <div class="empty-box soft" style="text-align: center; padding: 40px; color: var(--muted); border-radius: 12px;">
                <p style="margin: 0;">ì•„ì§ ë“±ë¡í•œ ê°•ì˜ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒë‹¨ì˜ â€œê°•ì˜ ë“±ë¡â€ìœ¼ë¡œ ì‹œì‘í•´ë³´ì„¸ìš”.</p>
            </div>
        {% endfor %}
    </div>

    {% if request.user == target_user %}
    <div class="action-fixed" style="margin-top: 40px; display: flex; gap: 10px; justify-content: flex-end;">
        <a href="{% url 'common:profile_edit' %}" class="btn-save" style="padding: 10px 18px; background: #00c471; color: white; border-radius: 8px; text-decoration: none; font-weight: bold;">ë‚´ ì •ë³´ ìˆ˜ì •</a>
        <a href="{% url 'common:password_change' %}" class="btn-outline" style="padding: 10px 18px; border: 1px solid var(--navbar-bg); color: var(--navbar-bg); border-radius: 8px; text-decoration: none; font-weight: bold;">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</a>
        <button type="button" class="btn-danger" id="deleteOpenBtn" style="padding: 10px 18px; border: 1px solid #fa5252; color: #fa5252; background: none; border-radius: 8px; font-weight: bold; cursor: pointer;">íšŒì›íƒˆí‡´</button>
    </div>
    {% endif %}

</div>

{% if request.user == target_user %}
<div id="deleteOverlay" class="confirm-overlay" aria-hidden="true" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000;">
    <div class="confirm-modal surface" style="padding: 25px; border-radius: 14px; max-width: 400px; width: 100%;">
        <h3 class="confirm-title" style="margin-top: 0;">ì •ë§ íƒˆí‡´í•˜ì‹œê² ì–´ìš”?</h3>
        <p class="confirm-desc muted" style="line-height: 1.6;">
            íƒˆí‡´í•˜ë©´ ê³„ì • ì ‘ê·¼ì´ ë¶ˆê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤.<br>
            ì§„í–‰ ì¤‘ì¸ ë°ì´í„°ê°€ ì‚­ì œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </p>

        <form method="POST" action="{% url 'common:delete_account' %}">
            {% csrf_token %}
            <div class="confirm-actions" style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button type="button" class="btn-ghost" id="deleteCancelBtn" onclick="document.getElementById('deleteOverlay').style.display='none'" style="padding: 8px 14px; border: 1px solid var(--border); background: var(--soft-bg); border-radius: 8px; cursor: pointer; color: var(--text); font-weight: bold;">ì·¨ì†Œ</button>
                <button type="submit" class="btn-danger-solid" style="padding: 8px 14px; background: #fa5252; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">íƒˆí‡´í•˜ê¸°</button>
            </div>
        </form>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="{% static 'teacherpage/js/dashboard.js' %}"></script>
<script>
    // 1. ìê¸°ì†Œê°œ í¼ ì „í™˜ ìŠ¤í¬ë¦½íŠ¸
    function showEditForm() {
        document.getElementById('bio-display').style.display = 'none';
        document.getElementById('bioEditBtn').style.display = 'none';
        document.getElementById('bio-form').style.display = 'block';
        document.getElementById('bio-input').focus();
    }

    function hideEditForm() {
        document.getElementById('bio-display').style.display = 'block';
        document.getElementById('bioEditBtn').style.display = 'inline-block';
        document.getElementById('bio-form').style.display = 'none';
    }

    // 2. ê°•ì˜ ì¹´ë“œ í´ë¦­ ì‹œ ì´ë™ ë¡œì§
    document.querySelectorAll('.course-card').forEach(function(card){
        card.addEventListener('click', function(){
            const href = card.getAttribute('data-href');
            if (href) window.location.href = href;
        });
    });

    // 3. ë²„íŠ¼ í´ë¦­ ì‹œ ì¹´ë“œ ë§í¬ ì´ë™ ë°©ì§€ (ì´ë²¤íŠ¸ ë²„ë¸”ë§ ì°¨ë‹¨)
    document.querySelectorAll('[data-stop="1"]').forEach(function(el){
        el.addEventListener('click', function(e){
            e.stopPropagation();
        });
    });

    // 4. íšŒì›íƒˆí‡´ ëª¨ë‹¬ ì œì–´
    const delOpen = document.getElementById('deleteOpenBtn');
    if(delOpen) {
        delOpen.addEventListener('click', () => {
            document.getElementById('deleteOverlay').style.display = 'flex';
        });
    }
</script>
{% endblock %}